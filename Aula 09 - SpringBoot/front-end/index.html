<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Roupas - CRUD Completo</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    .sidebar {
      min-height: 100vh;
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
    }

    .sidebar .nav-link {
      border-radius: 10px;
      margin: 5px 15px;
      transition: all 0.3s ease;
      color: white !important;
    }

    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      background: rgba(255, 255, 255, 0.2);
      transform: translateX(5px);
    }

    .main-card {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95);
    }

    .stats-card {
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .stats-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1) !important;
    }
  </style>
</head>

<body style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
  <div class="container-fluid">
    <div class="row">
      <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar">
        <div class="position-sticky pt-3">

          <div class="text-center pb-4">
            <div class="mx-auto mb-3 d-flex justify-content-center align-items-center shadow-lg"
              style="width: 70px; height: 70px; background: white; border-radius: 20px; transform: rotate(-5deg);">
              <i class="bi bi-tag-fill position-absolute text-primary opacity-25"
                style="font-size: 2.5rem; transform: translate(5px, 5px);"></i>
              <i class="bi bi-bag-check-fill text-primary"
                style="font-size: 2.2rem; position: relative; z-index: 2;"></i>
            </div>
            <h5 class="text-white fw-bold mb-0" style="letter-spacing: 1px;">ROUPAS <span class="fw-light">STORE</span>
            </h5>
            <div class="mx-auto bg-white opacity-25"
              style="width: 40px; height: 2px; border-radius: 2px; margin-top: 5px;"></div>
          </div>

          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" href="#" data-pagina="dashboard">
                <i class="bi bi-house-door me-3"></i>Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-pagina="cadastrar" onclick="resetarFormulario()">
                <i class="bi bi-plus-circle me-3"></i>Cadastrar Novo
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-pagina="consultar">
                <i class="bi bi-list-check me-3"></i>Consultar Estoque
                <span id="badgeTotalRoupas" class="badge bg-light text-dark ms-2">0</span>
              </a>
            </li>
          </ul>
        </div>
      </nav>

      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
        <div id="contentMain" class="main-card shadow-lg border-0 rounded-4 p-5 mb-5"
          style="transition: opacity 0.3s ease;">
        </div>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Variáveis de Controle
    let idEdicao = null;
    let dadosEstoque = { totalRoupas: 0, totalValor: 0, totalQuantidade: 0 };

    const API_URL = 'http://localhost:8080/roupas';

    function formatarMoeda(valor) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
    }

    // --- DASHBOARD ---
    async function atualizarDashboard() {
      try {
        const resposta = await fetch(API_URL);
        const produtos = await resposta.json();

        dadosEstoque.totalRoupas = produtos.length;
        dadosEstoque.totalQuantidade = produtos.reduce((t, p) => t + p.quantidade, 0);
        dadosEstoque.totalValor = produtos.reduce((t, p) => t + (p.quantidade * p.preco), 0);

        document.getElementById('badgeTotalRoupas').textContent = dadosEstoque.totalRoupas;

        if (document.getElementById('cardTotalRoupas')) {
          document.getElementById('cardTotalRoupas').textContent = dadosEstoque.totalRoupas;
          document.getElementById('cardTotalValor').textContent = formatarMoeda(dadosEstoque.totalValor);
          document.getElementById('cardTotalQuantidade').textContent = `${dadosEstoque.totalQuantidade} un`;
        }
      } catch (e) { console.error("Erro Dashboard:", e); }
    }

    // --- TEMPLATES ---
    const TEMPLATES = {
      dashboard: `
                <h1 class="display-5 fw-bold mb-4">Bem-vindo ao Sistema</h1>
                <div class="row g-4 mb-4">
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm p-4 text-center stats-card">
                            <h3 class="text-primary" id="cardTotalRoupas">0</h3>
                            <p class="text-muted mb-0">Roupas Cadastradas</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm p-4 text-center stats-card">
                            <h3 class="text-success" id="cardTotalValor">R$ 0,00</h3>
                            <p class="text-muted mb-0">Valor em Estoque</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm p-4 text-center stats-card">
                            <h3 class="text-warning" id="cardTotalQuantidade">0 un</h3>
                            <p class="text-muted mb-0">Total Peças</p>
                        </div>
                    </div>
                </div>
            `,
      cadastrar: `
                <h2 id="tituloForm"><i class="bi bi-plus-circle me-2"></i>Cadastrar Roupa</h2>
                <form id="formRoupas" class="mt-4">
                    <div class="row g-3">
                        <div class="col-md-6"><label class="form-label">Tipo</label>
                            <select class="form-select" id="tipo" required>
                                <option value="Camiseta">Camiseta</option><option value="Calça">Calça</option>
                                <option value="Blusa">Blusa</option><option value="Suéter">Suéter</option>
                            </select>
                        </div>
                        <div class="col-md-6"><label class="form-label">Marca</label><input type="text" class="form-control" id="marca" required></div>
                        <div class="col-md-4"><label class="form-label">Tamanho</label><input type="text" class="form-control" id="tamanho" required></div>
                        <div class="col-md-4"><label class="form-label">Quantidade</label><input type="number" class="form-control" id="quantidade" required></div>
                        <div class="col-md-4"><label class="form-label">Preço</label><input type="number" step="0.01" class="form-control" id="preco" required></div>
                    </div>
                    <button type="submit" id="btnSalvar" class="btn btn-primary btn-lg mt-4 px-5">Salvar Roupa</button>
                </form>
            `,
      consultar: `
          <div class="d-flex justify-content-between align-items-center mb-4">
              <h2>Estoque Atual</h2>
              <div class="input-group w-50">
                  <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                  <input type="text" id="inputBusca" class="form-control border-start-0" placeholder="Buscar por marca ou tipo..." onkeyup="filtrarTabela()">
              </div>
              <button class="btn btn-outline-primary" onclick="initConsulta()"><i class="bi bi-arrow-clockwise"></i></button>
          </div>
          <div class="table-responsive">
              <table class="table table-hover align-middle">
                  <thead class="table-light">
                      <tr><th>ID</th><th>Tipo</th><th>Marca</th><th>Tam</th><th>Qtd</th><th>Preço</th><th>Ações</th></tr>
                  </thead>
                  <tbody id="tabelaBody"></tbody>
              </table>
          </div>
`
    };

    // --- FUNÇÕES DE AÇÃO ---
    function trocarConteudo(pagina) {
      const container = document.getElementById('contentMain');
      container.style.opacity = '0';
      setTimeout(() => {
        container.innerHTML = TEMPLATES[pagina];
        container.style.opacity = '1';
        if (pagina === 'cadastrar') initCadastro();
        if (pagina === 'consultar') initConsulta();
        if (pagina === 'dashboard') atualizarDashboard();
      }, 200);
    }

    function initCadastro() {
      const form = document.getElementById('formRoupas');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const roupa = {
          tipo: document.getElementById('tipo').value,
          marca: document.getElementById('marca').value,
          tamanho: document.getElementById('tamanho').value,
          quantidade: parseInt(document.getElementById('quantidade').value),
          preco: parseFloat(document.getElementById('preco').value)
        };

        const url = idEdicao ? `${API_URL}/${idEdicao}` : API_URL;
        const metodo = idEdicao ? 'PUT' : 'POST';

        try {
          const res = await fetch(url, {
            method: metodo,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(roupa)
          });
          if (res.ok) {
            alert(idEdicao ? 'Atualizado!' : 'Cadastrado!');
            idEdicao = null;
            trocarConteudo('consultar');
          }
        } catch (err) { alert("Erro ao salvar"); }
      });
    }

    async function initConsulta() {
      const res = await fetch(API_URL);
      const produtos = await res.json();
      const body = document.getElementById('tabelaBody');
      body.innerHTML = produtos.map(p => `
                <tr>
                    <td>${p.id}</td>
                    <td><span class="badge bg-info text-dark">${p.tipo}</span></td>
                    <td>${p.marca}</td>
                    <td>${p.tamanho}</td>
                    <td>${p.quantidade}</td>
                    <td>${formatarMoeda(p.preco)}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick='prepararEdicao(${JSON.stringify(p)})'><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="excluirRoupa(${p.id})"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            `).join('');
      atualizarDashboard();
    }


    // Variável global (Solta no script)
    let idParaExcluir = null;

    // A função que APENAS abre o modal (Substitui a antiga)
    async function excluirRoupa(id) {
      idParaExcluir = id; // Guarda o ID para o botão do modal saber quem apagar
      const meuModal = new bootstrap.Modal(document.getElementById('modalExcluir'));
      meuModal.show(); // Abre o modal bonito
    }

    // O bloco de escuta(Solto no script, fora de qualquer function)
    document.addEventListener('click', async (e) => {
      if (e.target && e.target.id === 'btnConfirmarExclusao') {
        if (idParaExcluir) {
          try {
            await fetch(`${API_URL}/${idParaExcluir}`, { method: 'DELETE' });

            // Fecha o modal encontrando a instância aberta
            const modalElement = document.getElementById('modalExcluir');
            const modalInstancia = bootstrap.Modal.getInstance(modalElement);
            modalInstancia.hide();

            initConsulta(); // Atualiza a tabela
            idParaExcluir = null; // Limpa o ID
          } catch (error) {
            alert("Erro ao excluir: " + error.message);
          }
        }
      }
    });

    function prepararEdicao(p) {
      idEdicao = p.id;
      trocarConteudo('cadastrar');
      setTimeout(() => {
        document.getElementById('tituloForm').innerHTML = `<i class="bi bi-pencil-square me-2"></i>Editando ID: ${p.id}`;
        document.getElementById('btnSalvar').classList.replace('btn-primary', 'btn-warning');
        document.getElementById('btnSalvar').textContent = "Salvar Alterações";

        document.getElementById('tipo').value = p.tipo;
        document.getElementById('marca').value = p.marca;
        document.getElementById('tamanho').value = p.tamanho;
        document.getElementById('quantidade').value = p.quantidade;
        document.getElementById('preco').value = p.preco;
      }, 300);
    }

    function resetarFormulario() {
      idEdicao = null;
    }

    // Navegação
    document.querySelectorAll('[data-pagina]').forEach(link => {
      link.addEventListener('click', function () {
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
        trocarConteudo(this.getAttribute('data-pagina'));
      });
    });

    // Início
    trocarConteudo('dashboard');

    function filtrarTabela() {
      const termo = document.getElementById('inputBusca').value.toLowerCase();
      const linhas = document.querySelectorAll('#tabelaBody tr');

      linhas.forEach(linha => {
        // Pegamos o texto das colunas Tipo (index 1) e Marca (index 2)
        const tipo = linha.cells[1].innerText.toLowerCase();
        const marca = linha.cells[2].innerText.toLowerCase();

        // Se o termo de busca estiver contido no tipo OU na marca, mostra a linha
        if (tipo.includes(termo) || marca.includes(termo)) {
          linha.style.display = "";
        } else {
          linha.style.display = "none"; // Senão, esconde a linha
        }
      });
    }
  </script>

  <div class="modal fade" id="modalExcluir" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-danger text-white border-0">
          <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Confirmar</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-4 text-center">
          <h5>Deseja realmente excluir esta roupa?</h5>
          <p class="text-muted">Esta ação não poderá ser desfeita.</p>
        </div>
        <div class="modal-footer border-0 justify-content-center pb-4">
          <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" id="btnConfirmarExclusao" class="btn btn-danger px-4">Sim, Excluir</button>
        </div>
      </div>
    </div>
  </div>
</body>

</html>